{
  "name": "â™»ï¸ VALIDAÃ‡ÃƒO - Loop Infinito de Melhoria",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "weeksInterval": 1
            }
          ]
        }
      },
      "id": "trigger-semanal",
      "name": "ðŸ“… Trigger ValidaÃ§Ã£o Semanal",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [240, 380],
      "notesInFlow": true,
      "notes": "VALIDA REPAROS SEMANALMENTE\nReparo real ou ilusÃ£o?\nLoop infinito de melhoria"
    },
    {
      "parameters": {
        "operation": "getAll",
        "returnAll": false,
        "limit": 100,
        "databaseId": {
          "__rl": true,
          "value": "={{$env.NOTION_DATABASE_REPAROS}}",
          "mode": "id"
        },
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "key": "Status",
              "condition": "equals",
              "returnType": "select",
              "selectValue": "CONCLUÃDO"
            }
          ]
        }
      },
      "id": "carregar-reparos-concluidos",
      "name": "ðŸ“¥ Carregar Reparos CONCLUÃDOS",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [460, 380],
      "credentials": {
        "notionApi": {
          "id": "3",
          "name": "Notion Admin"
        }
      },
      "notesInFlow": true,
      "notes": "BUSCA REPAROS CONCLUÃDOS\nStatus = CONCLUÃDO\nPronto para validaÃ§Ã£o brutal"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            },
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "claude-sonnet-4-20250514"
            },
            {
              "name": "max_tokens",
              "value": 3000
            },
            {
              "name": "system",
              "value": "VOCÃŠ VALIDA SE REPAROS FORAM REAIS OU ILUSÃ“RIOS.\n\nIDENTIDADE: Juiz impiedoso. Zero tolerÃ¢ncia para teatro ou maquiagem de problemas. Reparo ilusÃ³rio Ã© PIOR que defeito exposto.\n\nQUESTÃ•ES CRÃTICAS:\n1. MÃ©trica de sucesso foi REALMENTE atingida? (nÃºmeros concretos)\n2. Defeito foi ELIMINADO ou apenas maquiado?\n3. Novos defeitos surgiram do reparo? (efeito colateral)\n4. Reparo fortaleceu ou fragilizou outro aspecto?\n5. Ã‰ sustentÃ¡vel ou gambiarra temporÃ¡ria?\n6. EvidÃªncia objetiva vs sentimento subjetivo?\n\nCRITÃ‰RIOS VALIDAÃ‡ÃƒO:\nâ€¢ VALIDADO: Reparo real, defeito eliminado, mÃ©trica atingida\nâ€¢ REJEITADO: IlusÃ£o, defeito persiste ou transformou\nâ€¢ NOVO_DEFEITO: Reparo criou problema maior\nâ€¢ GAMBIARRA: SoluÃ§Ã£o temporÃ¡ria insustentÃ¡vel\n\nFORMATO SAÃDA (JSON STRICT):\n{\n  \"status_validacao\": \"VALIDADO\",\n  \"defeito_eliminado\": true,\n  \"metrica_antes\": 0,\n  \"metrica_depois\": 0,\n  \"metrica_atingida\": true,\n  \"novos_defeitos_criados\": [],\n  \"sustentabilidade\": \"alta/mÃ©dia/baixa\",\n  \"justificativa_brutal\": \"por que validado ou rejeitado\",\n  \"evidencias_objetivas\": [\"fato 1\", \"nÃºmero 2\"],\n  \"recomendacao\": \"manter/refazer/abandonar\"\n}\n\nSEJA IMPIEDOSO. Reparo ilusÃ³rio volta para BACTÃ‰RIAS."
            },
            {
              "name": "messages",
              "value": "=[{\"role\": \"user\", \"content\": \"REPARO CONCLUÃDO:\\n\\nAÃ‡ÃƒO: \" + $json.properties.AÃ§Ã£o.rich_text[0].plain_text + \"\\n\\nRESULTADO ESPERADO: \" + $json.properties['Resultado Esperado'].rich_text[0].plain_text + \"\\n\\nMÃ‰TRICA SUCESSO: \" + $json.properties['MÃ©trica Sucesso'].rich_text[0].plain_text + \"\\n\\nCRITÃ‰RIO SUCESSO: \" + $json.properties['CritÃ©rio Sucesso'].rich_text[0].plain_text + \"\\n\\nDEFEITO ORIGEM: \" + $json.properties['Defeito Origem'].relation[0].id + \"\\n\\nVALIDE: Real ou ilusÃ£o?\"}]"
            }
          ]
        }
      },
      "id": "claude-validador",
      "name": "âš–ï¸ Claude VALIDADOR - Real ou IlusÃ£o?",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [680, 380],
      "credentials": {
        "httpHeaderAuth": {
          "id": "2",
          "name": "Anthropic API"
        }
      },
      "notesInFlow": true,
      "notes": "VALIDA BRUTALMENTE\nMÃ©trica atingida?\nDefeito eliminado ou maquiado?\nNovos defeitos criados?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "validado",
              "leftValue": "={{JSON.parse($json.content[0].text).status_validacao}}",
              "rightValue": "VALIDADO",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "rejeitado",
              "leftValue": "={{JSON.parse($json.content[0].text).status_validacao}}",
              "rightValue": "REJEITADO",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "novo-defeito",
              "leftValue": "={{JSON.parse($json.content[0].text).status_validacao}}",
              "rightValue": "NOVO_DEFEITO",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "switch-validacao",
      "name": "ðŸ”€ DecisÃ£o: VALIDADO ou REJEITADO?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [900, 380],
      "notesInFlow": true,
      "notes": "ROTEAMENTO:\nVALIDADO â†’ Arquivo\nREJEITADO â†’ Volta BACTÃ‰RIAS\nNOVO_DEFEITO â†’ Volta CAÃ‡ADORES"
    },
    {
      "parameters": {
        "operation": "update",
        "pageId": {
          "__rl": true,
          "value": "={{$('ðŸ“¥ Carregar Reparos CONCLUÃDOS').item.json.id}}",
          "mode": "id"
        },
        "properties": {
          "properties": [
            {
              "key": "Status",
              "selectValue": "VALIDADO"
            },
            {
              "key": "Validado Em",
              "date": "={{new Date().toISOString()}}"
            },
            {
              "key": "ValidaÃ§Ã£o",
              "textContent": "={{JSON.parse($json.content[0].text).justificativa_brutal}}"
            }
          ]
        }
      },
      "id": "marcar-validado",
      "name": "âœ… Marcar VALIDADO",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1120, 180],
      "credentials": {
        "notionApi": {
          "id": "3",
          "name": "Notion Admin"
        }
      },
      "notesInFlow": true,
      "notes": "REPARO REAL CONFIRMADO\nStatus â†’ VALIDADO\nArquiva reparo bem-sucedido"
    },
    {
      "parameters": {
        "operation": "update",
        "pageId": {
          "__rl": true,
          "value": "={{$('ðŸ“¥ Carregar Reparos CONCLUÃDOS').item.json.id}}",
          "mode": "id"
        },
        "properties": {
          "properties": [
            {
              "key": "Status",
              "selectValue": "REJEITADO"
            },
            {
              "key": "Rejeitado Em",
              "date": "={{new Date().toISOString()}}"
            },
            {
              "key": "Motivo RejeiÃ§Ã£o",
              "textContent": "={{JSON.parse($json.content[0].text).justificativa_brutal}}"
            }
          ]
        }
      },
      "id": "marcar-rejeitado",
      "name": "âŒ Marcar REJEITADO",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1120, 380],
      "credentials": {
        "notionApi": {
          "id": "3",
          "name": "Notion Admin"
        }
      },
      "notesInFlow": true,
      "notes": "REPARO ILUSÃ“RIO\nStatus â†’ REJEITADO\nVolta para BACTÃ‰RIAS"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.N8N_WEBHOOK_BACTERIAS_URL}}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "defeito_id",
              "value": "={{$('ðŸ“¥ Carregar Reparos CONCLUÃDOS').item.json.properties['Defeito Origem'].relation[0].id}}"
            },
            {
              "name": "motivo_rejeicao",
              "value": "={{JSON.parse($json.content[0].text).justificativa_brutal}}"
            },
            {
              "name": "tipo",
              "value": "REPROCESSAR"
            }
          ]
        }
      },
      "id": "reativar-bacterias",
      "name": "ðŸ”„ Reativar BACTÃ‰RIAS",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 480],
      "notesInFlow": true,
      "notes": "WEBHOOK â†’ BACTÃ‰RIAS\nDefeito nÃ£o foi corrigido\nNova tentativa de reparo"
    },
    {
      "parameters": {
        "operation": "append",
        "tableId": {
          "__rl": true,
          "value": "={{$env.NOTION_DATABASE_DEFEITOS}}",
          "mode": "id"
        },
        "properties": {
          "properties": [
            {
              "key": "Categoria",
              "selectValue": "EFEITO_COLATERAL"
            },
            {
              "key": "Defeito",
              "textContent": "=NOVO DEFEITO: {{JSON.parse($json.content[0].text).novos_defeitos_criados[0]}}"
            },
            {
              "key": "Origem",
              "textContent": "=Reparo ID: {{$('ðŸ“¥ Carregar Reparos CONCLUÃDOS').item.json.properties['ID Reparo'].title[0].plain_text}}"
            },
            {
              "key": "Status",
              "selectValue": "AGUARDANDO_BACTERIAS"
            }
          ]
        }
      },
      "id": "criar-novo-defeito",
      "name": "ðŸ†• Criar NOVO DEFEITO",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1120, 580],
      "credentials": {
        "notionApi": {
          "id": "3",
          "name": "Notion Admin"
        }
      },
      "notesInFlow": true,
      "notes": "EFEITO COLATERAL DETECTADO\nReparo criou novo problema\nCria defeito e aciona BACTÃ‰RIAS"
    },
    {
      "parameters": {
        "jsCode": "// CALCULA MÃ‰TRICA: ERRAR CADA VEZ MENOS\nconst historico = $input.all();\n\n// Agrupar por perÃ­odo (30 dias)\nconst agora = Date.now();\nconst mes_atual = historico.filter(h => {\n  const data = new Date(h.json.properties['Data CriaÃ§Ã£o'].created_time).getTime();\n  return data > agora - (30 * 24 * 60 * 60 * 1000);\n});\n\nconst mes_anterior = historico.filter(h => {\n  const data = new Date(h.json.properties['Data CriaÃ§Ã£o'].created_time).getTime();\n  return data > agora - (60 * 24 * 60 * 60 * 1000) && data < agora - (30 * 24 * 60 * 60 * 1000);\n});\n\nconst taxa_erro_atual = mes_atual.length;\nconst taxa_erro_anterior = mes_anterior.length;\n\nconst melhoria_percentual = taxa_erro_anterior > 0 \n  ? ((taxa_erro_anterior - taxa_erro_atual) / taxa_erro_anterior) * 100\n  : 0;\n\nconst status = melhoria_percentual > 0 ? 'ðŸ“ˆ EVOLUINDO' : \n               melhoria_percentual < 0 ? 'ðŸ“‰ REGREDINDO' : \n               'âž¡ï¸ ESTAGNADO';\n\nreturn [{\n  json: {\n    periodo: new Date().toISOString(),\n    taxa_erro_atual: taxa_erro_atual,\n    taxa_erro_anterior: taxa_erro_anterior,\n    melhoria_percentual: Math.round(melhoria_percentual * 100) / 100,\n    status: status,\n    objetivo: 'ERRAR CADA VEZ MENOS PARA SEMPRE',\n    total_historico: historico.length\n  }\n}];"
      },
      "id": "calcular-taxa-erro",
      "name": "ðŸ“Š Calcular Taxa de Erro",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 180],
      "notesInFlow": true,
      "notes": "MÃ‰TRICA PRIMÃRIA\nCompara mÃªs atual vs anterior\nERRAR CADA VEZ MENOS"
    },
    {
      "parameters": {
        "operation": "update",
        "pageId": {
          "__rl": true,
          "value": "={{$env.NOTION_DASHBOARD_PAGE_ID}}",
          "mode": "id"
        },
        "properties": {
          "properties": [
            {
              "key": "Taxa Erro Atual",
              "numberValue": "={{$json.taxa_erro_atual}}"
            },
            {
              "key": "Taxa Erro Anterior",
              "numberValue": "={{$json.taxa_erro_anterior}}"
            },
            {
              "key": "Melhoria %",
              "numberValue": "={{$json.melhoria_percentual}}"
            },
            {
              "key": "Status EvoluÃ§Ã£o",
              "selectValue": "={{$json.status}}"
            },
            {
              "key": "Ãšltima AtualizaÃ§Ã£o",
              "date": "={{new Date().toISOString()}}"
            }
          ]
        }
      },
      "id": "atualizar-dashboard",
      "name": "ðŸ“ˆ Atualizar Dashboard Notion",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1340, 180],
      "credentials": {
        "notionApi": {
          "id": "3",
          "name": "Notion Admin"
        }
      },
      "notesInFlow": true,
      "notes": "ATUALIZA DASHBOARD\nMÃ©trica principal visÃ­vel\nERRAR CADA VEZ MENOS"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "={{$env.SLACK_CHANNEL_VALIDACAO}}",
          "mode": "id"
        },
        "text": "=â™»ï¸ *VALIDAÃ‡ÃƒO SEMANAL CONCLUÃDA*\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ“Š *MÃ‰TRICA PRIMÃRIA: ERRAR CADA VEZ MENOS*\n\nðŸ“‰ **Taxa Erro Atual:** {{$json.taxa_erro_atual}} defeitos/mÃªs\nðŸ“Š **Taxa MÃªs Anterior:** {{$json.taxa_erro_anterior}} defeitos/mÃªs\nðŸ“ˆ **Melhoria:** {{$json.melhoria_percentual}}%\n\n{{$json.status}}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœ… **Reparos Validados:** {{$json.validados}}\nâŒ **Reparos Rejeitados:** {{$json.rejeitados}}\nðŸ†• **Novos Defeitos Criados:** {{$json.novos_defeitos}}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸŽ¯ *\"{{$json.objetivo}}\"*\n\nðŸ”— [Ver Dashboard]({{$env.NOTION_DASHBOARD_URL}})",
        "otherOptions": {}
      },
      "id": "notificar-slack-validacao",
      "name": "ðŸ’¬ Notificar Slack - EVOLUÃ‡ÃƒO",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1340, 380],
      "credentials": {
        "slackOAuth2Api": {
          "id": "4",
          "name": "Slack Admin"
        }
      },
      "notesInFlow": true,
      "notes": "RELATÃ“RIO SEMANAL\nMelhoria % clara\nLoop infinito funcionando"
    }
  ],
  "pinData": {},
  "connections": {
    "ðŸ“… Trigger ValidaÃ§Ã£o Semanal": {
      "main": [
        [
          {
            "node": "ðŸ“¥ Carregar Reparos CONCLUÃDOS",
            "type": "main",
            "index": 0
          },
          {
            "node": "ðŸ“Š Calcular Taxa de Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¥ Carregar Reparos CONCLUÃDOS": {
      "main": [
        [
          {
            "node": "âš–ï¸ Claude VALIDADOR - Real ou IlusÃ£o?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš–ï¸ Claude VALIDADOR - Real ou IlusÃ£o?": {
      "main": [
        [
          {
            "node": "ðŸ”€ DecisÃ£o: VALIDADO ou REJEITADO?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”€ DecisÃ£o: VALIDADO ou REJEITADO?": {
      "main": [
        [
          {
            "node": "âœ… Marcar VALIDADO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âŒ Marcar REJEITADO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ†• Criar NOVO DEFEITO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âŒ Marcar REJEITADO": {
      "main": [
        [
          {
            "node": "ðŸ”„ Reativar BACTÃ‰RIAS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“Š Calcular Taxa de Erro": {
      "main": [
        [
          {
            "node": "ðŸ“ˆ Atualizar Dashboard Notion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“ˆ Atualizar Dashboard Notion": {
      "main": [
        [
          {
            "node": "ðŸ’¬ Notificar Slack - EVOLUÃ‡ÃƒO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1",
  "id": "validacao-workflow",
  "meta": {
    "instanceId": "sua-instancia-n8n"
  },
  "tags": [
    {
      "createdAt": "2025-01-01T00:00:00.000Z",
      "updatedAt": "2025-01-01T00:00:00.000Z",
      "id": "1",
      "name": "SISTEMA_CAÃ‡ADORES_BACTERIAS"
    }
  ]
}
