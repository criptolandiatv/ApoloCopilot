{
  "name": "Rapid Test & Deploy Pipeline - CI/CD Master",
  "nodes": [
    {
      "parameters": {
        "events": ["push", "pull_request"],
        "repository": "={{ $env.GITHUB_REPO }}",
        "eventsUi": {
          "values": [
            {
              "name": "push"
            },
            {
              "name": "pull_request"
            }
          ]
        }
      },
      "id": "github-trigger",
      "name": "GitHub Events",
      "type": "n8n-nodes-base.githubTrigger",
      "typeVersion": 1.1,
      "position": [240, 400],
      "credentials": {
        "githubApi": {
          "id": "github-creds",
          "name": "GitHub API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse GitHub event and extract metadata\nconst event = $input.item(0).json;\n\nconst deployment = {\n  event_type: event.action || (event.ref ? 'push' : 'unknown'),\n  repository: event.repository?.full_name,\n  branch: event.ref?.replace('refs/heads/', '') || event.pull_request?.head?.ref,\n  commit: {\n    sha: event.after || event.pull_request?.head?.sha,\n    message: event.head_commit?.message || event.pull_request?.title,\n    author: event.head_commit?.author?.name || event.pull_request?.user?.login,\n    url: event.head_commit?.url || event.pull_request?.html_url\n  },\n  is_production: false,\n  environment: 'staging',\n  tests_required: true,\n  auto_deploy: false,\n  timestamp: new Date().toISOString()\n};\n\n// Determine environment and deployment strategy\nif (deployment.branch === 'main' || deployment.branch === 'master') {\n  deployment.is_production = true;\n  deployment.environment = 'production';\n  deployment.auto_deploy = false; // Require manual approval for prod\n} else if (deployment.branch === 'develop' || deployment.branch === 'staging') {\n  deployment.environment = 'staging';\n  deployment.auto_deploy = true;\n} else {\n  deployment.environment = 'preview';\n  deployment.auto_deploy = true;\n}\n\nreturn [{ json: deployment }];"
      },
      "id": "parse-event",
      "name": "Parse GitHub Event",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 400]
    },
    {
      "parameters": {
        "command": "=cd /tmp && git clone {{ $env.GITHUB_REPO_URL }} && cd $(basename {{ $env.GITHUB_REPO_URL }} .git) && git checkout {{ $json.commit.sha }}"
      },
      "id": "clone-repo",
      "name": "Clone Repository",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "command": "=cd /tmp/$(basename {{ $env.GITHUB_REPO_URL }} .git) && npm install && npm run test:unit && npm run test:integration"
      },
      "id": "run-tests",
      "name": "Run Test Suite",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "command": "=cd /tmp/$(basename {{ $env.GITHUB_REPO_URL }} .git) && npm run lint && npm run type-check"
      },
      "id": "run-lint",
      "name": "Lint & Type Check",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [900, 200]
    },
    {
      "parameters": {
        "command": "=cd /tmp/$(basename {{ $env.GITHUB_REPO_URL }} .git) && docker build -t {{ $env.DOCKER_IMAGE }}:{{ $json.commit.sha.substring(0,7) }} ."
      },
      "id": "build-image",
      "name": "Build Docker Image",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "jsCode": "// Aggregate test results\nconst items = $input.all();\nconst results = {\n  tests_passed: true,\n  lint_passed: true,\n  build_passed: true,\n  failures: [],\n  timestamp: new Date().toISOString()\n};\n\nitems.forEach((item, index) => {\n  const data = item.json;\n  if (data.exitCode && data.exitCode !== 0) {\n    if (index === 0) {\n      results.tests_passed = false;\n      results.failures.push('Test suite failed');\n    } else if (index === 1) {\n      results.lint_passed = false;\n      results.failures.push('Linting failed');\n    } else {\n      results.build_passed = false;\n      results.failures.push('Build failed');\n    }\n  }\n});\n\nresults.ready_to_deploy = results.tests_passed && results.lint_passed && results.build_passed;\n\nreturn [{ json: { ...items[0].json, test_results: results } }];"
      },
      "id": "aggregate-results",
      "name": "Aggregate Test Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.test_results.ready_to_deploy }}",
              "value2": true
            },
            {
              "value1": "={{ $json.auto_deploy }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-deploy-ready",
      "name": "Ready to Deploy?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "command": "=kubectl set image deployment/{{ $env.APP_NAME }} {{ $env.APP_NAME }}={{ $env.DOCKER_IMAGE }}:{{ $json.commit.sha.substring(0,7) }} -n {{ $json.environment }}"
      },
      "id": "deploy-k8s",
      "name": "Deploy to Kubernetes",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1780, 200]
    },
    {
      "parameters": {
        "command": "=kubectl rollout status deployment/{{ $env.APP_NAME }} -n {{ $json.environment }} --timeout=5m"
      },
      "id": "verify-deployment",
      "name": "Verify Deployment",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [2000, 200]
    },
    {
      "parameters": {
        "url": "={{ $env.HEALTH_CHECK_URL }}",
        "options": {
          "timeout": 30000,
          "retry": {
            "maxRetries": 5,
            "retryInterval": 5000
          }
        }
      },
      "id": "health-check",
      "name": "Health Check",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2220, 200]
    },
    {
      "parameters": {
        "jsCode": "// Run smoke tests against deployed environment\nconst deployment = $input.item(0).json;\n\nconst smokeTests = {\n  deployment_id: `${deployment.commit.sha.substring(0,7)}-${Date.now()}`,\n  environment: deployment.environment,\n  tests: [],\n  all_passed: true,\n  timestamp: new Date().toISOString()\n};\n\n// Simulate smoke tests (replace with actual test logic)\nconst tests = [\n  { name: 'API Response', endpoint: '/api/health', expected: 200 },\n  { name: 'Database Connection', endpoint: '/api/db-check', expected: 200 },\n  { name: 'Cache Layer', endpoint: '/api/cache-check', expected: 200 },\n  { name: 'Authentication', endpoint: '/api/auth/verify', expected: 200 }\n];\n\ntests.forEach(test => {\n  smokeTests.tests.push({\n    ...test,\n    status: 'passed', // In production, actually run these tests\n    duration_ms: Math.floor(Math.random() * 100) + 50\n  });\n});\n\nreturn [{ json: { ...deployment, smoke_tests: smokeTests } }];"
      },
      "id": "smoke-tests",
      "name": "Run Smoke Tests",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2440, 200]
    },
    {
      "parameters": {
        "resource": "issue",
        "operation": "createComment",
        "owner": "={{ $json.repository.split('/')[0] }}",
        "repository": "={{ $json.repository.split('/')[1] }}",
        "issueNumber": "={{ $json.pull_request?.number }}",
        "body": "=✅ **Deployment Successful**\\n\\n**Environment:** {{ $json.environment }}\\n**Commit:** {{ $json.commit.sha.substring(0,7) }}\\n**Tests:** {{ $json.smoke_tests.tests.length }}/{{ $json.smoke_tests.tests.length }} passed\\n\\n**Smoke Test Results:**\\n{{ $json.smoke_tests.tests.map(t => `- ✓ ${t.name} (${t.duration_ms}ms)`).join('\\n') }}\\n\\n**Deployment URL:** https://{{ $json.environment }}.example.com"
      },
      "id": "comment-pr",
      "name": "Comment on PR",
      "type": "n8n-nodes-base.github",
      "typeVersion": 1,
      "position": [2660, 200],
      "credentials": {
        "githubApi": {
          "id": "github-creds",
          "name": "GitHub API"
        }
      }
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "={{ $env.SLACK_DEPLOY_CHANNEL }}",
          "mode": "id"
        },
        "text": "=:rocket: *Deployment Successful*\\n\\n*Environment:* `{{ $json.environment }}`\\n*Branch:* `{{ $json.branch }}`\\n*Commit:* `{{ $json.commit.sha.substring(0,7) }}`\\n*Author:* {{ $json.commit.author }}\\n\\n*Tests:* {{ $json.test_results.tests_passed ? ':white_check_mark:' : ':x:' }} All passed\\n*Build:* {{ $json.test_results.build_passed ? ':white_check_mark:' : ':x:' }} Success\\n\\n<{{ $json.commit.url }}|View Commit>"
      },
      "id": "notify-slack",
      "name": "Notify Slack",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [2660, 320],
      "credentials": {
        "slackApi": {
          "id": "slack-creds",
          "name": "Slack API"
        }
      }
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "={{ $env.SLACK_DEPLOY_CHANNEL }}",
          "mode": "id"
        },
        "text": "=:x: *Deployment Failed*\\n\\n*Environment:* `{{ $json.environment }}`\\n*Branch:* `{{ $json.branch }}`\\n*Commit:* `{{ $json.commit.sha.substring(0,7) }}`\\n\\n*Failures:*\\n{{ $json.test_results.failures.map(f => `• ${f}`).join('\\n') }}\\n\\n*Action Required:* Review and fix issues before deploying.\\n\\n<{{ $json.commit.url }}|View Commit>"
      },
      "id": "notify-failure",
      "name": "Notify Failure",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [1780, 420],
      "credentials": {
        "slackApi": {
          "id": "slack-creds",
          "name": "Slack API"
        }
      }
    },
    {
      "parameters": {
        "command": "=kubectl rollback deployment/{{ $env.APP_NAME }} -n {{ $json.environment }}"
      },
      "id": "rollback",
      "name": "Rollback Deployment",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [2440, 400]
    }
  ],
  "connections": {
    "GitHub Events": {
      "main": [
        [
          {
            "node": "Parse GitHub Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse GitHub Event": {
      "main": [
        [
          {
            "node": "Clone Repository",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clone Repository": {
      "main": [
        [
          {
            "node": "Run Test Suite",
            "type": "main",
            "index": 0
          },
          {
            "node": "Lint & Type Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Test Suite": {
      "main": [
        [
          {
            "node": "Build Docker Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lint & Type Check": {
      "main": [
        [
          {
            "node": "Build Docker Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Docker Image": {
      "main": [
        [
          {
            "node": "Aggregate Test Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Test Results": {
      "main": [
        [
          {
            "node": "Ready to Deploy?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ready to Deploy?": {
      "main": [
        [
          {
            "node": "Deploy to Kubernetes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify Failure",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deploy to Kubernetes": {
      "main": [
        [
          {
            "node": "Verify Deployment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Deployment": {
      "main": [
        [
          {
            "node": "Health Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Health Check": {
      "main": [
        [
          {
            "node": "Run Smoke Tests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Smoke Tests": {
      "main": [
        [
          {
            "node": "Comment on PR",
            "type": "main",
            "index": 0
          },
          {
            "node": "Notify Slack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": 600
  },
  "staticData": null,
  "tags": [
    {
      "name": "CI/CD",
      "id": "cicd-tag"
    },
    {
      "name": "Testing",
      "id": "testing-tag"
    },
    {
      "name": "Deployment",
      "id": "deployment-tag"
    }
  ],
  "meta": {
    "templateCredsSetupCompleted": false,
    "instanceId": "cicd-pipeline-v1"
  },
  "id": "rapid-test-deploy-pipeline",
  "versionId": "production-v1"
}
